<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Import D3 visulaization library -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <!-- Initialize a global WBK function -->
    <script src="https://cdn.rawgit.com/maxlath/wikidata-sdk/dist/dist/wikibase-sdk.min.js"></script>
    <!-- Initialize a global wdk object using the WBK object -->
    <script src="https://cdn.rawgit.com/maxlath/wikidata-sdk/dist/dist/wikidata-sdk.min.js"></script>
    <script>
        const wbk = new WBK({
            instance: 'https://query.wikidata.org/',
            sparqlEndpoint: 'https://query.wikidata.org/sparql'
        });
    </script>

    <script>
        const wk = new WBK({
            instance: 'https://bio2rdf.org/sparql',
            sparqlEndpoint: 'https://bio2rdf.org/sparql'
        });
    </script>

</head>

<body>
    <pre id="output"></pre>
    <script>
        query =
            `SELECT ?drugLabel ?hasroleLabel ?dbID
                
            WHERE { 

            ?drug wdt:P2175 wd:Q18556697 . 
            ?drug wdt:P2868 ?hasrole . 
            ?drug wdt:P715 ?dbID . 

            SERVICE wikibase:label { bd:serviceParam wikibase:language \"en\" .}
        }`;

        fetch(
            wbk.sparqlQuery(query)
        ).then(Response => Response.json()
        ).then(wdk.simplify.sparqlResults
        ).then(
            function (Response) {

                var data = {};

                for (i = 0; i < 24; i++) {

                    query =
                        `PREFIX dbvoc: <http://bio2rdf.org/drugbank_vocabulary:> 
                    PREFIX dcterms: <http://purl.org/dc/terms/> 

                    select ?title ?targetName ?function

                    where {

                        <http://bio2rdf.org/drugbank:DB`+ Response[i].dbID + `> dcterms:title ?title. 
                        <http://bio2rdf.org/drugbank:DB`+ Response[i].dbID + `>dbvoc:target ?target . 
                        ?target dcterms:title ?targetName . 
                        ?target dbvoc:go-function ?function .

                    }`;


                    fetch(
                        wk.sparqlQuery(query)
                    ).then(SecResponse => SecResponse.json()
                    ).then(wdk.simplify.sparqlResults
                    ).then(
                        function (SecResponse) {

                            data.push(
                                {
                                    "name": "HIV", "children": [
                                        {
                                            "name": SecResponse[4].title, "children": [
                                                {
                                                    "name": SecResponse[4].targetName, "children": [
                                                        {
                                                            "name": SecResponse[4].function
                                                        }
                                                    ]
                                                }
                                            ]
                                        }
                                    ]
                                }
                            );
                        }
                    )

                }

            }
        )
    </script>
</body>

</html>